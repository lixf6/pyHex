# HEX 文件解析规则文档

## 一、背景

针对积累下来的标定数据文件（A2L 和 HEX），目前只能依赖商业软件较为粗糙的分析，存在以下问题：

1. **依赖外部商业软件**：成本高且容易被卡脖子
2. **分析能力受限**：不能很好的对这些积累的数据做自定义或更为详细的分析

因此需要先搞清楚具体的解析规则，在这基础上开发管理版本及分析的平台。

由于内部 HEX 是基于国标 ASAM-MCD 标准定义加之内部一些特殊处理逻辑后，综合出来的文件。经年累月后加之人员流动后，目前对这块完全熟悉的人，基本没有。

为此，综合了嵌入式开发的同事、HEX 相关的开发同事、标定组业务的同事沟通及调研后，整理了以上的解析文档，供后续业务开展及解析用。

**日常业务需求**：内部 A2L 文件需要匹配上 HEX 文件的数据行，用以数据值分析、信号量对比、异常值捕捉。

## 二、解析逻辑

### 核心逻辑

**A2L → HEX 规则**：

地址 `0x4f334` → 高位 `0004` 低位 `f334` → 对应 HEX 中：
- 高位为 `:020000040004##` 后置段
- 低位匹配 `F320~F340` 之间，按 `0~F` 叠加数到 `34`（即 `20 21 22 23... 29 2A 2B 2C 2D 2E 2F 30 31 32 33 34`）
- 后根据浮点数类型取 N 字节（取决于 Record Layout，默认 4 字节）

### 示例：A2L 中某信号

```a2l
/begin CHARACTERISTIC
/* Name                   */      CtrlACC_mV_11kwTurnU_C
/* Long Identifier        */      "剩余充电时间T4计算：11kw充电拐点电压"
/* Type                   */      VALUE
/* ECU Address            */      0x40314 /* @ECU_Address@CtrlACC_mV_11kwTurnU_C@ */
/* Record Layout          */      Scalar_FLOAT32_IEEE
/* Maximum Difference     */      0
/* Conversion Method      */      BMS_EstCRTACC_CM_single
/* Lower Limit            */      -3.4E+38
/* Upper Limit            */      3.4E+38
/end CHARACTERISTIC
```

### HEX 中匹配规则

#### 步骤 1：高位匹配段

地址 `0x40314` → 高位 `0004` 低位 `0314` → 结合内部 HEX 规则，得出高位段地址是：

```
:020000040004
```

#### 步骤 2：匹配到具体的行

```
:2002E00000005C42000000420000E0400000A0C1000000400000C03F00004040000040405E
:2003000000000000000000000000000000C05A4500C05A4500C05A450000C842000016435D
:200320000000164300002F4400000000000000006666863F000000403333733F00000040C8
```

#### 步骤 3：解析协议

`0314` 对应行及解析协议：

```
:20   0300     00   00000000000000000000000000C05A4500C05A4500C05A450000C84200001643 5D
长度  偏移地址  类型  数据                                                             校验和
```

#### 步骤 4：按 HEX 国标协议解析数据部分

按照 16 进制读取：

```
00000000   00000000   00000000   00C05A45       00C05A45 00C05A45 0000C842 00001643
0300~03    04~07     08~0B      0C~0F          0310~13   14~17     18~1B     1C~1F
```

所以 `0314` 完整的字节：`00C05A45`，按 `Scalar_FLOAT32_IEEE`（小端）解码（IEEE754 单精度解码结果）：**3500.0**

> 跟 INCA 等软件导出的数据是匹配的。

### 其他匹配参考

| 标定量名称 | 十六进制值 | 解码结果 |
|-----------|----------|---------|
| `CtrlACC_kwh_ChrgAndCoolEgy1_C` | `00000040` | 2.0 |
| `CtrlACC_kwh_ChrgAndCoolEgy2_C` | `0000C03F` | 1.5 |
| `CtrlACC_kwh_ChrgAndCoolEgy3_C` | `00004040` | 3.0 |
| `CtrlACC_kwh_ChrgAndCoolEgy4_C` | `00004040` | 3.0 |

## 三、小端换算参考

按小端（Little-Endian）解析 IEEE-754 float32：

```python
import struct

def bytes_to_float_le(b):
    """
    将字节数组按小端序解析为 IEEE-754 float32
    
    Args:
        b: 4 个字节的迭代器（0-255），按内存顺序（小端序）
    
    Returns:
        float: 解析后的浮点数值
    """
    return struct.unpack('<f', bytes(b))[0]

# 示例
print(bytes_to_float_le([0x00, 0xC0, 0x5A, 0x45]))  # -> 3500.0
print(bytes_to_float_le([0x00, 0x00, 0x00, 0x40]))  # -> 2.0
```

### 测试结果

```python
>>> bytes_to_float_le([0x00, 0xC0, 0x5A, 0x45])
3500.0

>>> bytes_to_float_le([0x00, 0x00, 0x00, 0x40])
2.0
```
